# S3 Configuration Guide

This guide explains how to configure your Streamlit app to use S3 instead of Firebase.

## Required Changes

### 1. Update Streamlit Secrets

You need to add S3 configuration to your Streamlit secrets. In your `.streamlit/secrets.toml` file (or Streamlit Cloud secrets), add:

```toml
[s3]
aws_access_key_id = "YOUR_ACCESS_KEY_ID"
aws_secret_access_key = "YOUR_SECRET_ACCESS_KEY"
region_name = "us-east-1"  # or your preferred region
bucket_name = "your-bucket-name"
prefix = ""  # Optional: folder path within bucket (e.g., "calls/" or "reports/")
```

### 2. S3 Bucket Structure

Your S3 bucket should contain PDF files. The app will:
- List all `.pdf` files in the bucket (or under the specified prefix)
- Download and parse each PDF
- Extract call data from the PDFs

Example bucket structure:
```
your-bucket/
  ├── 20250715_060053_TYIO-bpagent030844482%40nextiva.com-%2B14178141239-IN.pdf
  ├── 20250716_120000_TYIO-agent2@company.com-+14178141240-IN.pdf
  └── ...
```

### 3. PDF Format

The PDF parser expects PDFs generated by PyFPDF containing call analysis data. The parser will extract:
- **Date and Time**: From filename (format: `YYYYMMDD_HHMMSS_...`) or PDF content
- **Agent**: From filename or PDF content
- **Company**: From PDF content
- **Emotion Counts**: happy, angry, sad, neutral
- **Average Happiness**: Calculated or extracted from PDF
- **Low Confidences**: Extracted from PDF
- **Call Duration**: From speaking time data in PDF

### 4. IAM Permissions

Your AWS credentials need the following S3 permissions:
- `s3:ListBucket` - to list PDF files
- `s3:GetObject` - to download PDF files

Example IAM policy:
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::your-bucket-name",
                "arn:aws:s3:::your-bucket-name/*"
            ]
        }
    ]
}
```

### 5. Testing the PDF Parser

If you need to adjust the PDF parser for your specific PDF format, edit `pdf_parser.py`. The parser uses regex patterns to extract data from PDF text. You may need to adjust the patterns based on your actual PDF structure.

## Migration Checklist

- [ ] Install new dependencies: `pip install boto3 pdfplumber`
- [ ] Configure S3 credentials in Streamlit secrets
- [ ] Verify S3 bucket contains PDF files
- [ ] Test PDF parser with sample PDFs
- [ ] Update PDF parser patterns if needed based on your PDF format
- [ ] Remove Firebase credentials (no longer needed)

## Troubleshooting

### "No PDF files found in S3 bucket"
- Check that your `bucket_name` is correct
- Verify the `prefix` path if you're using one
- Ensure PDF files are actually in the bucket

### "Access denied to S3 bucket"
- Verify your AWS credentials are correct
- Check IAM permissions for your AWS user/role
- Ensure the bucket policy allows your credentials

### "Error parsing PDF"
- Check that PDFs are valid and not corrupted
- Review the PDF parser patterns in `pdf_parser.py`
- The parser may need adjustment for your specific PDF format

### Missing data fields
- The PDF parser extracts data using regex patterns
- You may need to customize `pdf_parser.py` to match your PDF structure
- Check the extracted text by adding debug prints in the parser

